name: 'Auto Translate and Release'

on:
  workflow_dispatch:
    inputs:
      openai_model:
        description: 'OpenAI Model'
        required: true
        default: 'gpt-4o-mini'
        type: string
      api_endpoint:
        description: 'API Endpoint (optional, defaults to OpenAI official)'
        required: false
        default: 'https://api.openai.com/v1'
        type: string
      target_language:
        description: 'Target Language'
        required: true
        default: 'ç®€ä½“ä¸­æ–‡'
        type: string
      release_tag:
        description: 'Release Tag (use "latest" for source repo latest tag, or specify custom tag)'
        required: false
        default: 'latest'
        type: string
      dry_run:
        description: 'Dry Run (analyze and translate only, no replacement/build)'
        required: false
        default: false
        type: boolean

jobs:
  translate:
    runs-on: ubuntu-latest
    outputs:
      translated: ${{ steps.check-translation.outputs.translated }}
      release-tag: ${{ steps.generate-tag.outputs.release-tag }}
    
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        
      - name: Restore translation cache
        uses: actions/cache@v4
        with:
          path: |
            translation-cache.json
          key: translation-cache-${{ inputs.openai_model }}-${{ inputs.target_language }}-${{ github.run_id }}
          restore-keys: |
            translation-cache-${{ inputs.openai_model }}-${{ inputs.target_language }}-
            translation-cache-${{ inputs.openai_model }}-
            translation-cache-
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Clone source repository
        run: |
          echo "ðŸ“¥ Cloning Modrinth source repository..."
          git clone --recurse-submodules https://github.com/modrinth/code.git modrinth-source
          cd modrinth-source
          echo "âœ… Repository cloned successfully"
          echo "ðŸ“Š Repository statistics:"
          find . -type f -name "*.vue" -o -name "*.ts" -o -name "*.js" -o -name "*.tsx" -o -name "*.jsx" | wc -l | xargs echo "Total relevant files:"
          echo ""
          echo "ðŸ“ Directory structure:"
          find . -type d -name "app*" | head -10
          echo ""
          echo "ðŸ“ Apps directory:"
          ls -la apps/ || echo "No apps directory found"
          echo ""
          echo "ðŸ“ Root directory:"
          ls -la .
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: 'modrinth-source/package.json'
          run_install: false
          
      - name: Verify package managers
        run: |
          echo "ðŸ“‹ Verifying package manager installations..."
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "pnpm version: $(pnpm --version)"
          if command -v yarn &> /dev/null; then
            echo "yarn version: $(yarn --version)"
          else
            echo "â„¹ï¸  yarn not available"
          fi
          
      - name: Extract translatable text
        run: |
          echo "ðŸ“ Extracting translatable text from apps/app-frontend..."
          node scripts/extract-text.js modrinth-source/apps/app-frontend
          
      - name: Translate text with AI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ inputs.openai_model }}
          API_ENDPOINT: ${{ inputs.api_endpoint }}
          TARGET_LANGUAGE: ${{ inputs.target_language }}
        run: |
          echo "ðŸ¤– Translating text with ${{ inputs.openai_model }}..."
          node scripts/translate-text.js
          
      - name: Save translation cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            translation-cache.json
          key: translation-cache-${{ inputs.openai_model }}-${{ inputs.target_language }}-${{ github.run_id }}
          
      - name: Upload translation artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: translation-artifacts-${{ github.run_id }}
          path: |
            extracted-text.json
            translations.json
            translation-mapping.json
            translation-cache.json
          retention-days: 30
          
      - name: Replace text in source code
        if: ${{ !inputs.dry_run }}
        run: |
          echo "ðŸ”„ Replacing text in source code..."
          cp -r modrinth-source modrinth-source-backup
          node scripts/replace-text.js modrinth-source
          
      - name: Check translation completion
        id: check-translation
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "translated=false" >> $GITHUB_OUTPUT
          else
            echo "translated=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate release tag
        id: generate-tag
        run: |
          FINAL_TAG="${{ inputs.release_tag }}-$(echo '${{ inputs.target_language }}' | tr '[:upper:]' '[:lower:]' | sed 's/ç®€ä½“ä¸­æ–‡/zh-cn/g' | sed 's/ç¹ä½“ä¸­æ–‡/zh-tw/g' | sed 's/english/en/g')"
          if [ "${{ inputs.release_tag }}" = "latest" ]; then
            SOURCE_TAG=$(git ls-remote --tags https://github.com/modrinth/code.git | grep -E 'refs/tags/v[0-9]+' | sort -V | tail -1 | sed 's/.*refs\/tags\///')
            FINAL_TAG="${SOURCE_TAG}-zh-cn"
          fi
          echo "release-tag=$FINAL_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Release tag will be: $FINAL_TAG"
          
      - name: Upload translated source code
        if: ${{ !inputs.dry_run }}
        uses: actions/upload-artifact@v4
        with:
          name: translated-source
          path: |
            modrinth-source/
            !modrinth-source/node_modules/
            !modrinth-source/.git/
            !modrinth-source/target/
          retention-days: 1
          
      - name: Generate summary report
        run: |
          echo "ðŸ“‹ Generating summary report..."
          echo "{\"simplified\": true, \"workflow\": \"simplified dependency installation\"}" > workflow-summary.json
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-reports-${{ github.run_id }}
          path: |
            replacement-report.json
            replacement-summary.md
            workflow-summary.json
          retention-days: 7

  build-platforms:
    needs: translate
    if: needs.translate.outputs.translated == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'linux'
            os: ubuntu-latest
            rust-targets: ''
            system-deps: 'sudo apt-get update && sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf'
            build-args: ''
          - platform: 'windows'
            os: windows-latest
            rust-targets: ''
            system-deps: ''
            build-args: ''
          - platform: 'macos-intel'
            os: macos-latest
            rust-targets: 'x86_64-apple-darwin'
            system-deps: ''
            build-args: '--target x86_64-apple-darwin'
          - platform: 'macos-arm'
            os: macos-latest
            rust-targets: 'aarch64-apple-darwin'
            system-deps: ''
            build-args: '--target aarch64-apple-darwin'
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Download translated source
        uses: actions/download-artifact@v4
        with:
          name: translated-source
          path: .
          
      - name: Check downloaded structure
        shell: bash
        run: |
          echo "ðŸ“ Current directory contents:"
          ls -la
          echo ""
          echo "ðŸ” Looking for modrinth-source or similar:"
          find . -name "*modrinth*" -type d 2>/dev/null || echo "No modrinth directories found"
          echo ""
          echo "ðŸ” Looking for apps directories:"
          find . -name "apps" -type d 2>/dev/null || echo "No apps directories found"
          echo ""
          echo "ðŸ“„ Looking for package.json files:"
          find . -name "package.json" -type f 2>/dev/null | head -5
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false
          
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
          
      - name: Add Rust targets
        if: matrix.rust-targets != ''
        shell: bash
        run: |
          echo "ðŸ¦€ Adding Rust target: ${{ matrix.rust-targets }}"
          rustup target add ${{ matrix.rust-targets }}
          echo "ðŸ“‹ Installed targets:"
          rustup target list --installed
        
      - name: Install system dependencies
        if: matrix.system-deps != ''
        run: ${{ matrix.system-deps }}
        
      - name: Simple directory search (All platforms)
        id: find-app-dir-simple
        shell: bash
        run: |
          echo "ðŸ” Simple directory search..."
          
          # Find any directory that contains package.json with Tauri dependencies
          FOUND_DIR=""
          
          # Search for package.json files and check for Tauri
          while IFS= read -r -d '' pkg_file; do
            echo "ðŸ“„ Checking: $pkg_file"
            dir=$(dirname "$pkg_file")
            
            # Check if this package.json contains Tauri dependencies
            if grep -q "tauri" "$pkg_file" 2>/dev/null; then
              echo "âœ… Found Tauri project in: $dir"
              FOUND_DIR="$dir"
              break
            fi
          done < <(find . -name "package.json" -type f -print0)
          
          # If no Tauri found, look for any app-like directory with package.json
          if [ -z "$FOUND_DIR" ]; then
            echo "âš ï¸  No Tauri project found, looking for app directories..."
            
            # Check common app directory patterns
            for pattern in "*/apps/*" "*/app" "apps/*" "app" "*frontend*" "frontend"; do
              for dir in $pattern; do
                if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
                  echo "âœ… Found app directory: $dir"
                  FOUND_DIR="$dir"
                  break 2
                fi
              done
            done
          fi
          
          if [ -z "$FOUND_DIR" ]; then
            echo "âŒ Could not find any suitable app directory"
            echo "ðŸ“ All directories:"
            find . -type d | head -20
            echo "ðŸ“„ All package.json files:"
            find . -name "package.json" -type f
            exit 1
          fi
          
          echo "app-dir=$FOUND_DIR" >> $GITHUB_OUTPUT
          echo "âœ… Selected app directory: $FOUND_DIR"
          
          
      - name: Install Node dependencies
        shell: bash
        run: |
          cd "${{ steps.find-app-dir-simple.outputs.app-dir }}"
          pnpm install
          
      - name: Build application
        shell: bash
        run: |
          echo "ðŸ—ï¸ Building for ${{ matrix.platform }}..."
          cd "${{ steps.find-app-dir-simple.outputs.app-dir }}"
          pnpm run tauri build ${{ matrix.build-args }}
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.platform }}
          path: |
            modrinth-source/apps/app/src-tauri/target/*/release/bundle/
            modrinth-source/apps/app/src-tauri/target/release/bundle/
          retention-days: 7
          if-no-files-found: warn

  create-release:
    needs: [translate, build-platforms]
    if: always() && needs.translate.outputs.translated == 'true' && (contains(needs.build-platforms.result, 'success'))
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-*
          path: build-artifacts/
          merge-multiple: true
          
      - name: List artifacts
        run: |
          echo "ðŸ“¦ Available build artifacts:"
          find build-artifacts/ -type f \( -name "*.exe" -o -name "*.msi" -o -name "*.dmg" -o -name "*.pkg" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \) || echo "No standard installer files found"
          echo ""
          echo "ðŸ“‹ All files in build artifacts:"
          find build-artifacts/ -type f | head -20
          
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.translate.outputs.release-tag }}
          TARGET_LANGUAGE: ${{ inputs.target_language }}
        run: |
          echo "ðŸš€ Creating GitHub release..."
          
          # Create release notes
          cat > release_notes.md << EOF
          # Modrinth Auto-Translated Release
          
          ðŸ¤– **AI Translation**: Translated to $TARGET_LANGUAGE using ${{ inputs.openai_model }}
          ðŸŒ **Multi-Platform**: Built for Linux, Windows, and macOS
          ðŸ“… **Build Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ## Platforms Included
          - ðŸ§ Linux (AppImage, .deb, .rpm)
          - ðŸªŸ Windows (.exe, .msi)
          - ðŸŽ macOS (.dmg, .pkg) - Intel & Apple Silicon
          
          ## Installation
          1. Download the appropriate file for your platform
          2. Install/run the application
          3. Enjoy Modrinth in $TARGET_LANGUAGE!
          
          ---
          *This release was automatically generated by GitHub Actions*
          EOF
          
          # Create release
          gh release create "$RELEASE_TAG" \
            --title "Modrinth $TARGET_LANGUAGE - $RELEASE_TAG" \
            --notes-file release_notes.md \
            --draft \
            build-artifacts/* || echo "Release creation failed, but continuing..."
            
          echo "âœ… Release process completed"