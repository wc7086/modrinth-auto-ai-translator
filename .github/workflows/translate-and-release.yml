name: 'Auto Translate and Release'

on:
  workflow_dispatch:
    inputs:
      openai_model:
        description: 'OpenAI Model'
        required: true
        default: 'gpt-4o-mini'
        type: string
      api_endpoint:
        description: 'API Endpoint (optional, defaults to OpenAI official)'
        required: false
        default: 'https://api.openai.com/v1'
        type: string
      target_language:
        description: 'Target Language'
        required: true
        default: '简体中文'
        type: string
      release_tag:
        description: 'Release Tag (use "latest" for source repo latest tag, or specify custom tag)'
        required: false
        default: 'latest'
        type: string
      dry_run:
        description: 'Dry Run (analyze and translate only, no replacement/build)'
        required: false
        default: false
        type: boolean

jobs:
  translate-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        
      - name: Restore translation cache
        uses: actions/cache@v4
        with:
          path: |
            translation-cache.json
          key: translation-cache-${{ inputs.openai_model }}-${{ inputs.target_language }}-${{ github.run_id }}
          restore-keys: |
            translation-cache-${{ inputs.openai_model }}-${{ inputs.target_language }}-
            translation-cache-${{ inputs.openai_model }}-
            translation-cache-
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
          run_install: false
          
      - name: Verify package managers
        run: |
          echo "📋 Verifying package manager installations..."
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          if command -v pnpm &> /dev/null; then
            echo "pnpm version: $(pnpm --version)"
          else
            echo "⚠️  pnpm not found, installing..."
            npm install -g pnpm@8
            echo "pnpm version: $(pnpm --version)"
          fi
          if command -v yarn &> /dev/null; then
            echo "yarn version: $(yarn --version)"
          else
            echo "ℹ️  yarn not available"
          fi
          
      - name: Clone source repository
        run: |
          echo "📥 Cloning Modrinth source repository..."
          git clone --recurse-submodules https://github.com/modrinth/code.git modrinth-source
          cd modrinth-source
          echo "✅ Repository cloned successfully"
          echo "📊 Repository statistics:"
          find . -type f -name "*.vue" -o -name "*.ts" -o -name "*.js" -o -name "*.tsx" -o -name "*.jsx" | wc -l | xargs echo "Total relevant files:"
          
      - name: Extract translatable text
        run: |
          echo "📝 Extracting translatable text from apps/app-frontend..."
          node scripts/extract-text.js modrinth-source/apps/app-frontend
          
      - name: Translate text with AI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ inputs.openai_model }}
          API_ENDPOINT: ${{ inputs.api_endpoint }}
          TARGET_LANGUAGE: ${{ inputs.target_language }}
        run: |
          echo "🤖 Translating text with ${{ inputs.openai_model }}..."
          node scripts/translate-text.js
          
      - name: Save translation cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            translation-cache.json
          key: translation-cache-${{ inputs.openai_model }}-${{ inputs.target_language }}-${{ github.run_id }}
          
      - name: Upload translation artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: translation-artifacts-${{ github.run_id }}
          path: |
            extracted-text.json
            translations.json
            translation-mapping.json
            translation-cache.json
          retention-days: 30
          
      - name: Replace text in source code
        if: ${{ !inputs.dry_run }}
        run: |
          echo "🔄 Replacing text in source code..."
          cp -r modrinth-source modrinth-source-backup
          node scripts/replace-text.js modrinth-source
          
      - name: Upload translated source code
        if: ${{ !inputs.dry_run }}
        uses: actions/upload-artifact@v4
        with:
          name: translated-source-${{ github.run_id }}
          path: |
            modrinth-source/
            !modrinth-source/node_modules/
            !modrinth-source/.git/
            !modrinth-source/target/
          retention-days: 1
          
      - name: Trigger platform builds
        if: ${{ !inputs.dry_run }}
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: build-platforms
          client-payload: |
            {
              "run_id": "${{ github.run_id }}",
              "release_tag": "${{ inputs.release_tag }}",
              "target_language": "${{ inputs.target_language }}",
              "openai_model": "${{ inputs.openai_model }}"
            }
          
      - name: Generate summary report
        run: |
          echo "📋 Generating summary report..."
          echo "{\"simplified\": true, \"workflow\": \"simplified dependency installation\"}" > workflow-summary.json
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-reports-${{ github.run_id }}
          path: |
            replacement-report.json
            replacement-summary.md
            workflow-summary.json
          retention-days: 7